FROM centos:6.7

SHELL ["/bin/sh", "-c"],

ENV PATH /opt/gitlab/embedded/bin:/opt/gitlab/bin:/assets:$PATH
COPY assets/ /assets/

# Update CentOS yum repo URLs
RUN \cp /assets/other/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo 

RUN \
  yum update -y -q -e 0 \
  && yum install -y \
	  tar \
	  wget \
	  unzip \
	  initscripts \
	  sudo
	  
RUN chkconfig iptables off
RUN \cp /assets/other/sudoers /etc/sudoers

RUN rpm -ivH /assets/nginx/nginx-1.4.0-1.el6.ngx.x86_64.rpm

# Deploy vulnerable nginx version 1.4.0 and update binary with known memory locations (faster exploitation)
RUN \
  service nginx stop \
  && chmod +x /assets/nginx/nginx \
  && \cp /assets/nginx/nginx /usr/sbin/nginx \
  && \cp /assets/nginx/nginx.conf /etc/nginx/ \
  && \cp /assets/nginx/default.conf /etc/nginx/conf.d/ \
  && mkdir -p /usr/local/nginx/logs
  
RUN \
  mkdir -p /opt/virsec \
  && \cp -R /assets/virsec/PA /opt/virsec/ \
  && find /opt/virsec -name "*.sh" -execdir chmod +x {} +

EXPOSE 80

ENTRYPOINT ["/assets/wrapper.sh"]

HEALTHCHECK --interval=5m --timeout=3s \
  CMD curl --fail http://127.0.0.1 || exit 1